<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta charset="utf-8" />
        <script src="cordova.js"></script>
        <script src="kendo/js/jquery.min.js"></script>
        <script src="kendo/js/kendo.mobile.min.js"></script>
        <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
        <link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />
        <link href="styles/main.css" rel="stylesheet" />
       <script src="scripts/soundmanager2.js"></script>
    </head>
    <body>
        <div data-role="view" id="tabstrip-home">
            <h1 style="text-align:center">Welcome to Vernaculate</h1>
            <p>
                Vernaculate allows you to translate phrases into multiple languages at once, 
                enabling you to compare the sounds and structure of each specific language.
            </p>
            <a class="menuButtons" data-role="button" href="">Select Default Language</a><br/>
            <a class="menuButtons" data-role="button" href="">Settings</a><br/>
            <a class="menuButtons" data-role="button" href="">About</a><br/>
            <div id="rrr"></div>
        </div>

        <div data-role="view" id="tab-vernaculate">
            <div data-role="header">
                <div data-role="navbar">
                    <a data-role="button" data-align="left" data-icon="globe"
                       data-rel="popover" href="#pop-langs" style="padding:-25px;">èªž</a>
                  <input type="text" style="width: 11em; height: 30px; padding:2px;" 
                  value="Enter your phrase here" data-align="left" id="wordSearch"/>
                  <a data-role="button" data-align="right" id="searchButton">Search</a>
                </div>
            </div>
            
            <ul id="translated" data-role="listview" data-type="group">
                <h2>Try translating above !</h2>
                
            </ul><!--this is where all phrases end up-->
            
            <div id="pop-langs" data-role="popover"><!-- popover containing languages -->
                <div data-role="view">
                 <div data-role="fieldcontain">
                  <fieldset data-role="controlgroup">
	               <legend>Select languages you would like displayed:</legend>
                   <label><input type="checkbox" value="ar"/>Arabic</label><br/><!--=-->
                   <label><input type="checkbox" value="bg"/>Bulgarian</label><br/><!--=-->
                   <label><input type="checkbox" value="ca"/>Catalan</label><br/> 
                   <label><input type="checkbox" value="zh-cn"/>Chinese</label><br/>  
                   <label><input type="checkbox" value="da"/>Danish</label><br/>   
                   <label><input type="checkbox" value="nl"/>Dutch</label><br/>
	               <label><input type="checkbox" value="en"/>English</label><br/>
                   <label><input type="checkbox" value="fi"/>Finnish</label><br/>
	               <label><input type="checkbox" value="fr"/>French</label><br/>
                   <label><input type="checkbox" value="de"/>German</label><br/>
                   <label><input type="checkbox" value="hi"/>Hindi</label><br/><!--=-->
                   <label><input type="checkbox" value="it"/>Italian</label><br/>
                   <label><input type="checkbox" value="ja"/>Japanese</label><br/>
                   <label><input type="checkbox" value="ko"/>Korean</label><br/>
                   <label><input type="checkbox" value="no"/>Norwegian</label><br/>
                   <label><input type="checkbox" value="pl"/>Polish</label><br/>
                   <label><input type="checkbox" value="pt"/>Portuguese</label><br/>
                   <label><input type="checkbox" value="ru"/>Russian</label><br/>
                   <label><input type="checkbox" value="es"/>Spanish</label><br/>
                   <label><input type="checkbox" value="sv"/>Swedish</label><br/>
                   <label><input type="checkbox" value="th"/>Thai</label><br/><!--=-->
                   <label><input type="checkbox" value="tr"/>Turkish</label><br/><!--=-->
                  </fieldset>
                 </div>
                </div>
            </div>
        </div>

        <div data-role="layout" data-id="mobile-tabstrip"><!-- footer -->
            <div data-role="footer">
                <div data-role="tabstrip">
                    <a href="#tabstrip-home" data-icon="home">Home</a>
                    <a href="#tab-vernaculate" data-icon="globe">Vernaculate</a>
                </div>
            </div>
        </div>

        <!-- MODAL VIEW template -->
        <div data-role="modalview" id="modal1" data-open="logTarget" style="width:275px; height:360px">
           <!-- header is fixed to the top of the modal view -->
           <div data-role="header" id="modalHead" style="background-color: rgba(120,155,200,.8);">
               <div data-align="right" id="currentLang"></div>
               <div id="navDiv" data-role="navbar">
                 <div id="headerDiv">                        <!-- without clearing this div all styling is removed -->
                      <div data-align="left" id="fullPhrase"></div>
                 </div> 
               </div>
           </div>
           <!-- navbar outside of header is places on top of modal view -->
           <div data-role="navbar"> 
               <a data-role="button" id="textToSpeechButton" float="left">speak</a>
               <a data-role="button" id="closeModal" float="right">Close</a>
           </div>
            <div id="modalText"></div><br/>                  <!-- where the phrase is broken down -->
            <div id="langCode" style="display: none;"></div> <!--stores current language code, not visible -->
            <div id="canSpeak" style="display: none;"></div> <!-- whether or not TTS will work, not visible -->
        </div>
        
        
        <script>
            var app = new kendo.mobile.Application(document.body, { transition: "slide", layout: "mobile-tabstrip" });
            /////////  TRANSLATE METHODS ///////////
            var phraseArr = [];  //array holding temp translated phrases
            var phraseIndex;     //var to hold index of each phrase
            var defaultLang = "en";
            
            //button click event
            //main 'translate' function; checks 'checked' checkboxes, then 
            //calls my TranslationAPI to do the translation
            $("#searchButton").click(function(){
                $("#translated").empty(); //empty out the result list
                phraseArr.length = 0; //empty out the temp phrase list
                phraseIndex = -1;
                $("fieldset input:checked").each(function(){
                    var to = this.value;
                    var text = $('#wordSearch').val();
                    //JSON object being sent; untranslated
                    var untranslated = {"value":text, "lang":to};
                    $.ajax({
                      type: "POST",
                      dataType: "json",
                      data: "{}",
                      contentType: "application/json",
                      data: JSON.stringify(untranslated),
                      url:"http://localhost:64600/api/translate/",
                      success:(addEachPhrase)
                    });
                });
                           
            });
            //add each phrase to the list, formatted accordingly
            function addEachPhrase(response){   
                phraseIndex+=1;
                phraseArr[phraseIndex]=response;
                $("#translated").append('<li><div style="background-color: rgba(120,155,200,0.5);"><p class="floatLeft">'
                +response.langName+'</p><p class="floatRight"><a class="appendedButton" href="#modal1" data-rel="modalview">'
                +'define</a></p><div style="clear: both;"></div></div><div style="font-size:1.8em;">'+ response.value + '</div></li><br/>');
                button = $(".appendedButton").kendoMobileButton(); 
            }                    
                                
            ///////////TEXT - TO - SPEECH //////////////
            var mySound;
            $("#textToSpeechButton").click(function(e){ 
                 $.ajax({
                    type: "GET",
                    url:"http://localhost:64600/api/translate/",
                    success:(getTTS)
                 });
            });  
            //first_response holds access token                    
            function getTTS(first_response) {
                    var textToSpeak;
                    var langToSpeak;
                    console.log($("#canSpeak").text());
                    //checks to see if language is supported by TTS service
                    if($("#canSpeak").text() == "No"){
                        textToSpeak = $("#currentLang").text()+" is not supported by text to speech";
                        langToSpeak = defaultLang;
                    }else{
                        textToSpeak = $("#fullPhrase").text();
                        langToSpeak = $("#langCode").text();
                    }
                 var s = document.createElement("script");
                 s.src = "http://api.microsofttranslator.com/V2/Ajax.svc/Speak?appId=Bearer " 
                       + encodeURIComponent(first_response.access_token) + "&text="
                       + textToSpeak+"&language="+langToSpeak+"&format=audio/mp3";
                 $.ajax({
                       url: s.src,
                       success:function(response){
                         //response.replace prepares returned URL for passing into sound manager
                         response = response.replace(/\\/g, ""); //remove all \ characters
                         response = response.replace(/"/g, '');  //remove " from beginning and end 
                         //console.log("HHHHHH:"+response);
                         soundManage(response);    
                       }
                 });
			}  
            function soundManage(response) {
               soundManager.setup({
                 url: 'soundmanager2.swf',
                 onready: function() {
                    // Ready to use; soundManager.createSound() etc. can now be called.
                    soundManager.destroySound('aSound');     
                    mySound = soundManager.createSound({
                        id:'aSound',
                        url: response
                    });
                    mySound.play();       
                 }
              });     
            }           
			
            ///////// MODAL VIEW FUNCTIONS ////////////////
            $("#closeModal").click(function(){
                var modal = $("#modal1").data("kendoMobileModalView");
                modal.close();
            });
                       
            //finds the phrase that was clicked on to open the modal view
            function logTarget(e){
                //clear all data fields in the modal view
                $("#modalText").empty(); $("#headerDiv").empty(); $("#canSpeak").empty();
                $("#fullPhrase").empty(); $("#currentLang").empty(); $("#langCode").empty();
                 //console.log(phraseArr[index].langName);  
                //receives index of current selected phrase
                var index = $('#translated li div a').index(e.target); 
                console.log(index);
                $("#fullPhrase").append('<h2>'+phraseArr[index].value+'</h2>');
                $("#currentLang").append(phraseArr[index].langName); $("#langCode").append(phraseArr[index].lang); 
                $("#modalText").append('<ul id="translatedWords" data-role="listview"></ul>');
                if(phraseArr[index].canSpeak == false){
                    $("#canSpeak").append("No");
                }else{
                    $("#canSpeak").append("Yes");
                }
                //THIS WILL NOT WORK with certain characters (ex. japanese) which don't have spaces between them.
                for(i=0; i < phraseArr[index].words.length; i++){
                   //each word in here
                   console.log(phraseArr[index].langName);
                   $("#translatedWords").append('<li><div class="sum" style="font-size:1.6em">'+
                   phraseArr[index].words[i].theWord+'<br/>'+phraseArr[index].words[i].definition+'</div></li>');
                }
                //css fixes to the header according to the phrase length
                var height = $("#fullPhrase").height();
                $("#navDiv").css("height",height); height += 30; $("#modalHead").css("height",height);
            }       
        </script>
    </body>
</html>
